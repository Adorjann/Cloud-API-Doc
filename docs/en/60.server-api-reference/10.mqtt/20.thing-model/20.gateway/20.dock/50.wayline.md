




 # Event

## Notification of device exits the return-to-home (RTH) state
**Topic:** thing/product/{pid}/events

**Direction:** up

**Method:** device_exit_homing_notify

**Data:** 
|Column|Name|Type|constraint|Description|
|---|---|---|---|---|
 |action|Notification type of exiting RTH|enum|[{&#34;1&#34;:&#34;Enter exiting RTH state&#34;},{&#34;0&#34;:&#34;Exit exiting RTH state&#34;}]|Enter exiting RTH state means that the dock exits the RTH process when the dock is in the RTH mode because of the reasons shown in the field reason. Similarly, exit exiting RTH state means the dock stops the process of exiting RTH.|
 |reason|Reason of exiting RTH|enum|{&#34;0&#34;:&#34;Add joystick throttle&#34;,&#34;1&#34;:&#34;Add joystick pitch&#34;,&#34;2&#34;:&#34;The initialization of behavior tree is failed&#34;,&#34;3&#34;:&#34;Surrounded by obstacles&#34;,&#34;4&#34;:&#34;Flight restricton is triggered&#34;,&#34;5&#34;:&#34;Obstacle is too closed&#34;,&#34;6&#34;:&#34;No GPS signal&#34;,&#34;7&#34;:&#34;The output flag of GPS and VIO location is false&#34;,&#34;8&#34;:&#34;The error of GPS and VIO fusion position is too large&#34;,&#34;9&#34;:&#34;Backtrack in short distance&#34;,&#34;10&#34;:&#34;Trigger the RTH in short distance&#34;}||

 

**Example:**
```json
{
	"bid": "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxx",
	"tid": "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxx",
	"method": "device_exit_homing_notify",
	"need_reply": true,
	"timestamp:": 1654070968655,
	"data": {
		"action": 1,
		"sn": "Dock sn",
		"reason": "0"
	}
}
```




## Report wayline task progress
**Topic:** thing/product/{pid}/events

**Direction:** up

**Method:** flighttask_progress

**Data:** 
|Column|Name|Type|constraint|Description|
|---|---|---|---|---|
|ext|Expand content|struct||| 
|»current_waypoint_index|Current waypoint number|int|{}|| 
|»media_count|The number of media files generated by the execution of this wayline task|int|{}|| 
|»track_id|Wayline ID|text|{}|| 
|»flight_id|Task ID|text|{}|| 
 |status|Task state|enum|{&#34;partially_done&#34;:&#34;partially done&#34;,&#34;sent&#34;:&#34;sent&#34;,&#34;in_progress&#34;:&#34;in progress&#34;,&#34;ok&#34;:&#34;success&#34;,&#34;paused&#34;:&#34;paused&#34;,&#34;rejected&#34;:&#34;rejected&#34;,&#34;failed&#34;:&#34;failed&#34;,&#34;canceled&#34;:&#34;canceled or stopped&#34;,&#34;timeout&#34;:&#34;timeout&#34;}||
|progress|Progress|struct||| 
|»current_step|steps|enum|{&#34;0-4&#34;:&#34;MissionCenter starting, checking and recovering&#34;,&#34;5-18&#34;:&#34;Waiting state&#34;,&#34;19, 20&#34;:&#34;Task executing&#34;,&#34;21-29&#34;:&#34;Returning to home&#34;,&#34;30-39&#34;:&#34;Pulling logs&#34;,&#34;Others&#34;:&#34;Interaction completed&#34;}|| 
|»percent|Progress value|int|{&#34;min&#34;:&#34;0&#34;,&#34;max&#34;:&#34;100&#34;,&#34;step&#34;:&#34;1&#34;}|| 

 

**Example:**
```json
{
	"bid": "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxx",
	"tid": "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxx",
	"data": {
		"output": {
			"ext": {
				"current_waypoint_index": 3,
				"media_count": 6,
				"track_id": "track_id",
				"flight_id": "flight_id"
			},
			"progress": {
				"current_step": 19,
				"percent": 100
			},
			"status": "ok"
		},
		"result": 0
	},
	"method": "flighttask_progress",
	"timestamp": 1654070968655
}
```



**Topic:** thing/product/{pid}/events_reply

**Direction:** down

**Method:** flighttask_progress

**Data:**
|Column|Name|Type|constraint|Description|
|---|---|---|---|---|
|result|Return code|int||Non-0 means error|

**Example:**
```json
{
	"method": "flighttask_progress",
	"tid": "6a7bfe89-c386-4043-b600-b518e10096cc",
	"bid": "42a19f36-5117-4520-bd13-fd61d818d52e",
	"timestamp": "1234567890123",
	"data": {
		"result": 0
	}
}
```





 # Service

## Create wayline task (Deprecated)



**Topic:** thing/product/{pid}/services

**Direction:** down

**Method:** flighttask_create

**Data:**
 |Column|Name|Type|constraint|Description| 
|---|---|---|---|---|
|flight_id|Task ID|text|{}||
|type|Task type|text|{}||
|file|Wayline file object|struct||| 
|»url|File URL|text|{}|| 
|»sign|MD5 signature|text|{}|| 

 

**Example:**
```json
{
	"method": "flighttask_create",
	"timestamp:": 1654070968655,
	"bid": "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxx",
	"tid": "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxx",
	"data": {
		"flight_id": "xxxxxxx",
		"type": "wayline",
		"file": {
			"url": "https://xxx.com/xxxx",
			"sign": "xxxx"
		}
	}
}
```



**Topic:** thing/product/{pid}/services_reply

**Direction:** up

**Method:** flighttask_create

**Data:**
|Column|Name|Type|constraint|Description|
|---|---|---|---|---|
|result|Return Code|int||Non-0 means error|

 

**Example:**
```json
{
	"method": "flighttask_create",
	"bid": "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxx",
	"tid": "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxx",
	"timestamp:": 1654070968655,
	"data": {
		"result": 0
	}
}
```


## Issue wayline task

If user&#39;s cloud service can not connect to the Internet (that is, the WAN), it is necessary to implement the `update configuration` function to send the URL of the NTP service which can be accessed by the cloud service in order to synchronize the clock. Otherwise, the wayline task can not work properly.

**Topic:** thing/product/{pid}/services

**Direction:** down

**Method:** flighttask_prepare

**Data:**
 |Column|Name|Type|constraint|Description| 
|---|---|---|---|---|
|flight_id|Task ID|text|{}||
|execute_time|Time to execute|int|{&#34;length&#34;:13}|Millisecond timestamp of task execution time|
 |task_type|Task type|enum|{&#34;0&#34;:&#34;Immediate task&#34;,&#34;1&#34;:&#34;Timing task&#34;}||
 |wayline_type|Wayline type|enum|{&#34;0&#34;:&#34;Normal waypoint wayline&#34;}||
|file|Wayline file object|struct||| 
|»url|File URL|text|{}|| 
|»fingerprint|File signature|text|{}|File content MD5 signature| 
|rth_altitude|Height of RTH|int|{&#34;unit&#34;:&#34;meter&#34;,&#34;min&#34;:20,&#34;max&#34;:500}||
 |out_of_control_action|Action when the device is out of control|enum|{&#34;0&#34;:&#34;Return to Home (RTH)&#34;,&#34;1&#34;:&#34;Hovering&#34;,&#34;2&#34;:&#34;Landing&#34;}||

 

**Example:**
```json
{
	"method": "flighttask_prepare",
	"timestamp": 1234567890123,
	"tid": "123",
	"bid": "456",
	"data": {
		"execute_time": 1234567890123,
		"flight_id": "xxxxxxx",
		"task_type": 1,
		"wayline_type": 1,
		"file": {
			"url": "https://xxx.com/xxxx",
			"fingerprint": "xxxx"
		},
		"rth_altitude": 100,
		"out_of_control_action": 0
	}
}
```



**Topic:** thing/product/{pid}/services_reply

**Direction:** up

**Method:** flighttask_prepare

**Data:**
|Column|Name|Type|constraint|Description|
|---|---|---|---|---|
|result|Return Code|int||Non-0 means error|

 

**Example:**
```json
{
	"method": "flighttask_prepare",
	"tid": "123",
	"bid": "456",
	"timestamp": 1234567890123,
	"data": {
		"result": 0
	}
}
```


## Execute wayline task



**Topic:** thing/product/{pid}/services

**Direction:** down

**Method:** flighttask_execute

**Data:**
 |Column|Name|Type|constraint|Description| 
|---|---|---|---|---|
|flight_id|Task ID|text|{}||

 

**Example:**
```json
{
	"method": "flighttask_execute",
	"timestamp": 1234567890123,
	"tid": "123",
	"bid": "456",
	"data": {
		"flight_id": "xxxxxxx"
	}
}
```



**Topic:** thing/product/{pid}/services_reply

**Direction:** up

**Method:** flighttask_execute

**Data:**
|Column|Name|Type|constraint|Description|
|---|---|---|---|---|
|result|Result Code|int|{}|Non-0 means error|

 

**Example:**
```json
{
	"method": "flighttask_execute",
	"tid": "123",
	"bid": "456",
	"timestamp": 1234567890123,
	"data": {
		"result": 0
	}
}
```


## Cancel wayline task



**Topic:** thing/product/{pid}/services

**Direction:** down

**Method:** flighttask_undo

**Data:**
 |Column|Name|Type|constraint|Description| 
|---|---|---|---|---|
  |flight_ids|Task ID|array|{&#34;item&#34;:{&#34;type&#34;:&#34;text&#34;}}|| 
    

 

**Example:**
```json
{
	"method": "flighttask_undo",
	"timestamp": 1234567890123,
	"tid": "123",
	"bid": "456",
	"data": {
		"flight_ids": [
			"aaaaaaa",
			"bbbbbbb"
		]
	}
}
```



**Topic:** thing/product/{pid}/services_reply

**Direction:** up

**Method:** flighttask_undo

**Data:**
|Column|Name|Type|constraint|Description|
|---|---|---|---|---|
|result|Return Code|int||Non-0 means error|

 

**Example:**
```json
{
	"method": "flighttask_undo",
	"tid": "123",
	"bid": "456",
	"timestamp": 1234567890123,
	"data": {
		"result": 0
	}
}
```



 # Requests

## Get the wayline task resource



**Topic:** thing/product/{pid}/requests

**Direction:** up

**Method:** flighttask_resource_get

**Data:**
|Column|Name|Type|constraint|Description|
|---|---|---|---|---|
|flight_id|Task ID|text|{}||

 

**Example:**
```json
{
	"method": "flighttask_resource_get",
	"timestamp": 1234567890123,
	"tid": "123",
	"bid": "456",
	"data": {
		"flight_id": "xxxxxxx"
	}
}
```



**Topic:** thing/product/{pid}/requests_reply

**Direction:** down

**Method:** flighttask_resource_get

**Data:**
|Column|Name|Type|constraint|Description|
|---|---|---|---|---|
|result|Return Code|int||Non-0 means error|
|output|Output|struct||| 
|»file|Wayline file object|struct|||
|»»url|File URL|text|{}||
|»»fingerprint|File signature|text|{}|File MD5 signature|

 

**Example:**
```json
{
	"method": "flighttask_resource_get",
	"tid": "123",
	"bid": "456",
	"timestamp": 1234567890123,
	"data": {
		"result": 0,
		"output": {
			"file": {
				"fingerprint": "signxxxx",
				"url": "https://xx.oss-cn-hangzhou.aliyuncs.com/xx.kmz?Expires=xx&OSSAccessKeyId=xxx&Signature=xxx"
			}
		}
	}
}
```


